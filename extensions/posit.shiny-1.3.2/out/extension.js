"use strict";var vr=Object.create;var Ee=Object.defineProperty;var yr=Object.getOwnPropertyDescriptor;var wr=Object.getOwnPropertyNames;var Tr=Object.getPrototypeOf,Er=Object.prototype.hasOwnProperty;var xe=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports),xr=(n,t)=>{for(var e in t)Ee(n,e,{get:t[e],enumerable:!0})},Nt=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of wr(t))!Er.call(n,i)&&i!==e&&Ee(n,i,{get:()=>t[i],enumerable:!(r=yr(t,i))||r.enumerable});return n};var _=(n,t,e)=>(e=n!=null?vr(Tr(n)):{},Nt(t||!n||!n.__esModule?Ee(e,"default",{value:n,enumerable:!0}):e,n)),Sr=n=>Nt(Ee({},"__esModule",{value:!0}),n);var sn=xe(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});var De=new Function("return this")().Promise,tt=!1;try{tt=new Function("return (async function(){}).constructor")()}catch(n){if(!(n instanceof SyntaxError))throw n}function Kt(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function ye(n,t,e){for(var r in t)Kt(t,r)&&(t[r]!=null&&typeof t[r]=="object"&&(r==="storage"||r==="prefixes")&&!e?n[r]=ye({},t[r]):n[r]=t[r]);return n}function Nr(n,t,e,r){var i,s;return typeof t.autoTrim=="string"?i=s=t.autoTrim:Array.isArray(t.autoTrim)&&(i=t.autoTrim[1],s=t.autoTrim[0]),(e||e===!1)&&(i=e),(r||r===!1)&&(s=r),i==="slurp"&&s==="slurp"?n.trim():(i==="_"||i==="slurp"?String.prototype.trimLeft?n=n.trimLeft():n=n.replace(/^[\s\uFEFF\xA0]+/,""):(i==="-"||i==="nl")&&(n=n.replace(/^(?:\n|\r|\r\n)/,"")),s==="_"||s==="slurp"?String.prototype.trimRight?n=n.trimRight():n=n.replace(/[\s\uFEFF\xA0]+$/,""):(s==="-"||s==="nl")&&(n=n.replace(/(?:\n|\r|\r\n)$/,"")),n)}function br(n){return/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n)}var Ie=function(){function n(t){this.cache=t}return n.prototype.define=function(t,e){this.cache[t]=e},n.prototype.get=function(t){return this.cache[t]},n.prototype.remove=function(t){delete this.cache[t]},n.prototype.reset=function(){this.cache={}},n.prototype.load=function(t){ye(this.cache,t,!0)},n}();function Ar(n,t){Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t}function A(n){var t=new Error(n);return Ar(t,A.prototype),t}A.prototype=Object.create(Error.prototype,{name:{value:"Squirrelly Error",enumerable:!1}});function J(n,t,e){var r=t.slice(0,e).split(/\n/),i=r.length,s=r[i-1].length+1;throw n+=" at line "+i+" col "+s+`:

  `+t.split(/\n/)[i-1]+`
  `+Array(s).join(" ")+"^",A(n)}var X=/^async +/,Ne=/`(?:\\[\s\S]|\${(?:[^{}]|{(?:[^{}]|{[^}]*})*})*}|(?!\${)[^\\`])*`/g,be=/'(?:\\[\s\w"'\\`]|[^\n\r'\\])*?'/g,Ae=/"(?:\\[\s\w"'\\`]|[^\n\r"\\])*?"/g,Vt=/[.*+\-?^${}()|[\]\\]/g;function ke(n){return Vt.test(n)?n.replace(Vt,"\\$&"):n}function Yt(n,t){t.rmWhitespace&&(n=n.replace(/[\r\n]+/g,`
`).replace(/^\s+|\s+$/gm,"")),Ne.lastIndex=0,be.lastIndex=0,Ae.lastIndex=0;var e=t.prefixes,r=[e.h,e.b,e.i,e.r,e.c,e.e].reduce(function(m,S){return m&&S?m+"|"+ke(S):S?ke(S):m},""),i=new RegExp("([|()]|=>)|('|\"|`|\\/\\*)|\\s*((\\/)?(-|_)?"+ke(t.tags[1])+")","g"),s=new RegExp("([^]*?)"+ke(t.tags[0])+"(-|_)?\\s*("+r+")?\\s*","g"),o=0,a=!1;function l(m,S){var E={f:[]},w=0,R="c";S==="h"||S==="b"||S==="c"?R="n":S==="r"&&(E.raw=!0,S="i");function v(V){var ae=n.slice(o,V),j=ae.trim();if(R==="f")j==="safe"?E.raw=!0:t.async&&X.test(j)?(j=j.replace(X,""),E.f.push([j,"",!0])):E.f.push([j,""]);else if(R==="fp")E.f[E.f.length-1][1]+=j;else if(R==="err"){if(j){var le=ae.search(/\S/);J("invalid syntax",n,o+le)}}else E[R]=j;o=V+1}i.lastIndex=o;for(var y;(y=i.exec(n))!==null;){var h=y[1],p=y[2],P=y[3],T=y[4],N=y[5],b=y.index;if(h)h==="("?(w===0&&(R==="n"?(v(b),R="p"):R==="f"&&(v(b),R="fp")),w++):h===")"?(w--,w===0&&R!=="c"&&(v(b),R="err")):w===0&&h==="|"?(v(b),R="f"):h==="=>"&&(v(b),o+=1,R="res");else if(p){if(p==="/*"){var Y=n.indexOf("*/",i.lastIndex);Y===-1&&J("unclosed comment",n,y.index),i.lastIndex=Y+2}else if(p==="'"){be.lastIndex=y.index;var G=be.exec(n);G?i.lastIndex=be.lastIndex:J("unclosed string",n,y.index)}else if(p==='"'){Ae.lastIndex=y.index;var O=Ae.exec(n);O?i.lastIndex=Ae.lastIndex:J("unclosed string",n,y.index)}else if(p==="`"){Ne.lastIndex=y.index;var U=Ne.exec(n);U?i.lastIndex=Ne.lastIndex:J("unclosed string",n,y.index)}}else if(P)return v(b),o=b+y[0].length,s.lastIndex=o,a=N,T&&S==="h"&&(S="s"),E.t=S,E}return J("unclosed tag",n,m),E}function c(m,S){m.b=[],m.d=[];var E=!1,w=[];function R(U,V){U&&(U=Nr(U,t,a,V),U&&(U=U.replace(/\\|'/g,"\\$&").replace(/\r\n|\n|\r/g,"\\n"),w.push(U)))}for(var v;(v=s.exec(n))!==null;){var y=v[1],h=v[2],p=v[3]||"",P;for(var T in e)if(e[T]===p){P=T;break}R(y,h),o=v.index+v[0].length,P||J("unrecognized tag type: "+p,n,o);var N=l(v.index,P),b=N.t;if(b==="h"){var Y=N.n||"";t.async&&X.test(Y)&&(N.a=!0,N.n=Y.replace(X,"")),N=c(N),w.push(N)}else if(b==="c"){if(m.n===N.n)return E?(E.d=w,m.b.push(E)):m.d=w,m;J("Helper start and end don't match",n,v.index+v[0].length)}else if(b==="b"){E?(E.d=w,m.b.push(E)):m.d=w;var G=N.n||"";t.async&&X.test(G)&&(N.a=!0,N.n=G.replace(X,"")),E=N,w=[]}else if(b==="s"){var O=N.n||"";t.async&&X.test(O)&&(N.a=!0,N.n=O.replace(X,"")),w.push(N)}else w.push(N)}if(S)R(n.slice(o,n.length),!1),m.d=w;else throw A('unclosed helper "'+m.n+'"');return m}var u=c({f:[]},!0);if(t.plugins)for(var f=0;f<t.plugins.length;f++){var g=t.plugins[f];g.processAST&&(u.d=g.processAST(u.d,t))}return u.d}function nt(n,t){var e=Yt(n,t),r="var tR='';"+(t.useWith?"with("+t.varName+"||{}){":"")+Z(e,t)+"if(cb){cb(null,tR)} return tR"+(t.useWith?"}":"");if(t.plugins)for(var i=0;i<t.plugins.length;i++){var s=t.plugins[i];s.processFnString&&(r=s.processFnString(r,t))}return r}function Ze(n,t){for(var e=0;e<t.length;e++){var r=t[e][0],i=t[e][1],s=t[e][2];n=(s?"await ":"")+"c.l('F','"+r+"')("+n,i&&(n+=","+i),n+=")"}return n}function qt(n,t,e,r,i,s){var o="{exec:"+(i?"async ":"")+st(e,t,n)+",params:["+r+"]";return s&&(o+=",name:'"+s+"'"),i&&(o+=",async:true"),o+="}",o}function kr(n,t){for(var e="[",r=0;r<n.length;r++){var i=n[r];e+=qt(t,i.res||"",i.d,i.p||"",i.a,i.n),r<n.length&&(e+=",")}return e+="]",e}function st(n,t,e){return"function("+t+"){var tR='';"+Z(n,e)+"return tR}"}function Z(n,t){var e=0,r=n.length,i="";for(e;e<r;e++){var s=n[e];if(typeof s=="string"){var o=s;i+="tR+='"+o+"';"}else{var a=s.t,l=s.c||"",c=s.f,u=s.n||"",f=s.p||"",g=s.res||"",m=s.b,S=!!s.a;if(a==="i"){t.defaultFilter&&(l="c.l('F','"+t.defaultFilter+"')("+l+")");var E=Ze(l,c);!s.raw&&t.autoEscape&&(E="c.l('F','e')("+E+")"),i+="tR+="+E+";"}else if(a==="h")if(t.storage.nativeHelpers.get(u))i+=t.storage.nativeHelpers.get(u)(s,t);else{var w=(S?"await ":"")+"c.l('H','"+u+"')("+qt(t,g,s.d,f,S);m?w+=","+kr(m,t):w+=",[]",w+=",c)",i+="tR+="+Ze(w,c)+";"}else a==="s"?i+="tR+="+Ze((S?"await ":"")+"c.l('H','"+u+"')({params:["+f+"]},[],c)",c)+";":a==="e"&&(i+=l+`
`)}}return i}function ie(n,t,e,r){if(t&&t.length>0)throw A((r?"Native":"")+"Helper '"+n+"' doesn't accept blocks");if(e&&e.length>0)throw A((r?"Native":"")+"Helper '"+n+"' doesn't accept filters")}function Jt(n,t,e,r,i){e(n[t],t).then(function(s){r+=s,t===n.length-1?i(r):Jt(n,t+1,e,r,i)})}function Xt(n,t,e,r,i,s){r(t[e],n[t[e]]).then(function(o){i+=o,e===t.length-1?s(i):Xt(n,t,e+1,r,i,s)})}var Dr={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function Or(n){return Dr[n]}function Ir(n){var t=String(n);return/[&<>"']/.test(t)?t.replace(/[&<>"']/g,Or):t}var Zt=new Ie({}),Le=new Ie({each:function(n,t){var e="",r=n.params[0];if(ie("each",t,!1),n.async)return new Promise(function(s){Jt(r,0,n.exec,e,s)});for(var i=0;i<r.length;i++)e+=n.exec(r[i],i);return e},foreach:function(n,t){var e=n.params[0];if(ie("foreach",t,!1),n.async)return new Promise(function(s){Xt(e,Object.keys(e),0,n.exec,"",s)});var r="";for(var i in e)Kt(e,i)&&(r+=n.exec(i,e[i]));return r},include:function(n,t,e){ie("include",t,!1);var r=e.storage.templates.get(n.params[0]);if(!r)throw A('Could not fetch template "'+n.params[0]+'"');return r(n.params[1],e)},extends:function(n,t,e){var r=n.params[1]||{};r.content=n.exec();for(var i=0;i<t.length;i++){var s=t[i];r[s.name]=s.exec()}var o=e.storage.templates.get(n.params[0]);if(!o)throw A('Could not fetch template "'+n.params[0]+'"');return o(r,e)},useScope:function(n,t){return ie("useScope",t,!1),n.exec(n.params[0])}}),Qt=new Ie({if:function(n,t){ie("if",!1,n.f,!0);var e="if("+n.p+"){"+Z(n.d,t)+"}";if(n.b)for(var r=0;r<n.b.length;r++){var i=n.b[r];i.n==="else"?e+="else{"+Z(i.d,t)+"}":i.n==="elif"&&(e+="else if("+i.p+"){"+Z(i.d,t)+"}")}return e},try:function(n,t){if(ie("try",!1,n.f,!0),!n.b||n.b.length!==1||n.b[0].n!=="catch")throw A("native helper 'try' only accepts 1 block, 'catch'");var e="try{"+Z(n.d,t)+"}",r=n.b[0];return e+="catch"+(r.res?"("+r.res+")":"")+"{"+Z(r.d,t)+"}",e},block:function(n,t){ie("block",n.b,n.f,!0);var e="if(!"+t.varName+"["+n.p+"]){tR+=("+st(n.d,"",t)+")()}else{tR+="+t.varName+"["+n.p+"]}";return e}}),zt=new Ie({e:Ir}),Oe={varName:"it",autoTrim:[!1,"nl"],autoEscape:!0,defaultFilter:!1,tags:["{{","}}"],l:function(n,t){if(n==="H"){var e=this.storage.helpers.get(t);if(e)return e;throw A("Can't find helper '"+t+"'")}else if(n==="F"){var r=this.storage.filters.get(t);if(r)return r;throw A("Can't find filter '"+t+"'")}},async:!1,storage:{helpers:Le,nativeHelpers:Qt,filters:zt,templates:Zt},prefixes:{h:"@",b:"#",i:"",r:"*",c:"/",e:"!"},cache:!1,plugins:[],useWith:!1};Oe.l.bind(Oe);function ce(n,t){var e={};return ye(e,Oe),t&&ye(e,t),n&&ye(e,n),e.l.bind(e),e}function Ue(n,t){var e=ce(t||{}),r=Function;if(e.async)if(tt)r=tt;else throw A("This environment doesn't support async/await");if(e.varName&&br(e.varName)===!1)throw A("options.varName must be a valid JS identifier");try{return new r(e.varName,"c","cb",nt(n,e))}catch(i){throw i instanceof SyntaxError?A(`Bad template syntax

`+i.message+`
`+Array(i.message.length+1).join("=")+`
`+nt(n,e)):i}}var rt=require("fs"),Qe=require("path"),Lr=/^\uFEFF/;function ze(n,t,e){var r=Qe.resolve(e?t:Qe.dirname(t),n),i=Qe.extname(n);return i||(r+=".sqrl"),r}function Ur(n,t){var e,r,i=t.views,s=/^[A-Za-z]+:\\|^\//.exec(n);if(s&&s.length)e=ze(n.replace(/^\/*/,""),t.root||"/",!0);else if(t.filename&&(r=ze(n,t.filename),rt.existsSync(r)&&(e=r)),e||Array.isArray(i)&&i.some(function(o){return r=ze(n,o,!0),rt.existsSync(r)})&&(e=r),!e)throw A('Could not find the include file "'+n+'"');return e}function en(n){return rt.readFileSync(n).toString().replace(Lr,"")}function tn(n,t){var e=ce(t),r=en(n);try{var i=Ue(r,e);return e.storage.templates.define(e.filename,i),i}catch{throw A("Loading file: "+n+" failed")}}function it(n){var t=n.filename;if(n.cache){var e=n.storage.templates.get(t);return e||tn(t,n)}return Ue(en(t),n)}function Mr(n,t,e){var r;if(e)try{it(n)(t,n,e)}catch(i){return e(i)}else{if(typeof De=="function")return new De(function(i,s){try{r=it(n)(t,n),i(r)}catch(o){s(o)}});throw A("Please provide a callback function, this env doesn't support Promises")}}function nn(n,t){var e=ce({filename:Ur(n,t)},t);return it(e)}function rn(n,t,e){t=t||{};var r=ce(t);return r.filename=n,Mr(r,t,e)}function $r(n,t,e){if(t&&t.length>0)throw A("Helper 'includeFile' doesn't accept blocks");return nn(n.params[0],e)(n.params[1],e)}function jr(n,t,e){var r=n.params[1]||{};r.content=n.exec();for(var i=0;i<t.length;i++){var s=t[i];r[s.name]=s.exec()}return nn(n.params[0],e)(r,e)}function et(n,t){var e;return t.cache&&t.name&&t.storage.templates.get(t.name)?t.storage.templates.get(t.name):(typeof n=="function"?e=n:e=Ue(n,t),t.cache&&t.name&&t.storage.templates.define(t.name,e),e)}function Hr(n,t,e,r){var i=ce(e||{});if(i.async){var s;if(r)try{et(n,i)(t,i,r)}catch(o){return r(o)}else{if(typeof De=="function")return new De(function(o,a){try{s=et(n,i)(t,i),o(s)}catch(l){a(l)}});throw A("Please provide a callback function, this env doesn't support Promises")}}else return et(n,i)(t,i)}Le.define("includeFile",$r);Le.define("extendsFile",jr);I.__express=rn;I.compile=Ue;I.compileScope=Z;I.compileScopeIntoFunction=st;I.compileToString=nt;I.defaultConfig=Oe;I.filters=zt;I.getConfig=ce;I.helpers=Le;I.loadFile=tn;I.nativeHelpers=Qt;I.parse=Yt;I.render=Hr;I.renderFile=rn;I.templates=Zt});var cn=xe(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.PythonExtension=Q.PVSC_EXTENSION_ID=void 0;var Yr=require("vscode");Q.PVSC_EXTENSION_ID="ms-python.python";var qr;(function(n){async function t(){let e=Yr.extensions.getExtension(Q.PVSC_EXTENSION_ID);if(e===void 0)throw new Error("Python extension is not installed or is disabled");return e.isActive||await e.activate(),e.exports}n.api=t})(qr=Q.PythonExtension||(Q.PythonExtension={}))});var Rn=xe((cs,Pn)=>{var at=require("util"),Jr=require("path"),z=require("child_process").spawn,M=function(){},lt="HKLM",un="HKCU",pn="HKCR",fn="HKU",dn="HKCC",hn=[lt,un,pn,fn,dn],mn="REG_SZ",gn="REG_MULTI_SZ",vn="REG_EXPAND_SZ",yn="REG_DWORD",wn="REG_QWORD",Tn="REG_BINARY",En="REG_NONE",xn=[mn,gn,vn,yn,wn,Tn,En],Xr="",Zr=/(\\[a-zA-Z0-9_\s]+)*/,Qr=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,Sn=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function pe(n,t){if(!(this instanceof pe))return new pe(n,t);Error.captureStackTrace(this,pe),this.__defineGetter__("name",function(){return pe.name}),this.__defineGetter__("message",function(){return n}),this.__defineGetter__("code",function(){return t})}at.inherits(pe,Error);function ee(n){var t={stdout:"",stderr:""};return n.stdout.on("data",function(e){t.stdout+=e.toString()}),n.stderr.on("data",function(e){t.stderr+=e.toString()}),t}function te(n,t,e){var r=e.stdout.trim(),i=e.stderr.trim(),s=at.format(`%s command exited with code %d:
%s
%s`,n,t,r,i);return new pe(s,t)}function zr(n){if(n=="x64")return"64";if(n=="x86")return"32";throw new Error("illegal architecture: "+n+" (use x86 or x64)")}function ne(n,t){t&&n.push("/reg:"+zr(t))}function re(){return process.platform==="win32"?Jr.join(process.env.windir,"system32","reg.exe"):"REG"}function we(n,t,e,r,i,s,o){if(!(this instanceof we))return new we(n,t,e,r,i,s,o);var a=n,l=t,c=e,u=r,f=i,g=s,m=o;this.__defineGetter__("host",function(){return a}),this.__defineGetter__("hive",function(){return l}),this.__defineGetter__("key",function(){return c}),this.__defineGetter__("name",function(){return u}),this.__defineGetter__("type",function(){return f}),this.__defineGetter__("value",function(){return g}),this.__defineGetter__("arch",function(){return m})}at.inherits(we,Object);function C(n){if(!(this instanceof C))return new C(n);var t=n||{},e=""+(t.host||""),r=""+(t.hive||lt),i=""+(t.key||""),s=t.arch||null;if(this.__defineGetter__("host",function(){return e}),this.__defineGetter__("hive",function(){return r}),this.__defineGetter__("key",function(){return i}),this.__defineGetter__("path",function(){return'"'+(e.length==0?"":"\\\\"+e+"\\")+r+i+'"'}),this.__defineGetter__("arch",function(){return s}),this.__defineGetter__("parent",function(){var o=i.lastIndexOf("\\");return new C({host:this.host,hive:this.hive,key:o==-1?"":i.substring(0,o),arch:this.arch})}),hn.indexOf(r)==-1)throw new Error("illegal hive specified.");if(!Zr.test(i))throw new Error("illegal key specified.");if(s&&s!="x64"&&s!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}C.HKLM=lt;C.HKCU=un;C.HKCR=pn;C.HKU=fn;C.HKCC=dn;C.HIVES=hn;C.REG_SZ=mn;C.REG_MULTI_SZ=gn;C.REG_EXPAND_SZ=vn;C.REG_DWORD=yn;C.REG_QWORD=wn;C.REG_BINARY=Tn;C.REG_NONE=En;C.REG_TYPES=xn;C.DEFAULT_VALUE=Xr;C.prototype.values=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["QUERY",this.path];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i="",s=this,o=null,a=ee(r);return r.on("close",function(l){if(!o)if(l!==0)M("process exited with code "+l),t(te("QUERY",l,a),null);else{for(var c=[],u=[],f=i.split(`
`),g=0,m=0,S=f.length;m<S;m++){var E=f[m].trim();E.length>0&&(M(E),g!=0&&c.push(E),++g)}for(var m=0,S=c.length;m<S;m++){var w=Sn.exec(c[m]),R,v,y;w&&(R=w[1].trim(),v=w[2].trim(),y=w[3],u.push(new we(s.host,s.hive,s.key,R,v,y,s.arch)))}t(null,u)}}),r.stdout.on("data",function(l){i+=l.toString()}),r.on("error",function(l){o=l,t(l)}),this};C.prototype.keys=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["QUERY",this.path];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i="",s=this,o=null,a=ee(r);return r.on("close",function(l){o||l!==0&&(M("process exited with code "+l),t(te("QUERY",l,a),null))}),r.stdout.on("data",function(l){i+=l.toString()}),r.stdout.on("end",function(){for(var l=[],c=[],u=i.split(`
`),f=0,g=u.length;f<g;f++){var m=u[f].trim();m.length>0&&(M(m),l.push(m))}for(var f=0,g=l.length;f<g;f++){var S=Qr.exec(l[f]),E,w;S&&(E=S[1],w=S[2],w&&w!==s.key&&c.push(new C({host:s.host,hive:s.hive,key:w,arch:s.arch})))}t(null,c)}),r.on("error",function(l){o=l,t(l)}),this};C.prototype.get=function(t,e){if(typeof e!="function")throw new TypeError("must specify a callback");var r=["QUERY",this.path];t==""?r.push("/ve"):r=r.concat(["/v",t]),ne(r,this.arch);var i=z(re(),r,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),s="",o=this,a=null,l=ee(i);return i.on("close",function(c){if(!a)if(c!==0)M("process exited with code "+c),e(te("QUERY",c,l),null);else{for(var u=[],f=null,g=s.split(`
`),m=0,S=0,E=g.length;S<E;S++){var w=g[S].trim();w.length>0&&(M(w),m!=0&&u.push(w),++m)}var R=u[u.length-1]||"",v=Sn.exec(R),y,h,p;v&&(y=v[1].trim(),h=v[2].trim(),p=v[3],f=new we(o.host,o.hive,o.key,y,h,p,o.arch)),e(null,f)}}),i.stdout.on("data",function(c){s+=c.toString()}),i.on("error",function(c){a=c,e(c)}),this};C.prototype.set=function(t,e,r,i){if(typeof i!="function")throw new TypeError("must specify a callback");if(xn.indexOf(e)==-1)throw Error("illegal type specified.");var s=["ADD",this.path];t==""?s.push("/ve"):s=s.concat(["/v",t]),s=s.concat(["/t",e,"/d",r,"/f"]),ne(s,this.arch);var o=z(re(),s,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),a=null,l=ee(o);return o.on("close",function(c){a||(c!==0?(M("process exited with code "+c),i(te("ADD",c,l,null))):i(null))}),o.stdout.on("data",function(c){M(""+c)}),o.on("error",function(c){a=c,i(c)}),this};C.prototype.remove=function(t,e){if(typeof e!="function")throw new TypeError("must specify a callback");var r=t?["DELETE",this.path,"/f","/v",t]:["DELETE",this.path,"/f","/ve"];ne(r,this.arch);var i=z(re(),r,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),s=null,o=ee(i);return i.on("close",function(a){s||(a!==0?(M("process exited with code "+a),e(te("DELETE",a,o),null)):e(null))}),i.stdout.on("data",function(a){M(""+a)}),i.on("error",function(a){s=a,e(a)}),this};C.prototype.clear=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["DELETE",this.path,"/f","/va"];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i=null,s=ee(r);return r.on("close",function(o){i||(o!==0?(M("process exited with code "+o),t(te("DELETE",o,s),null)):t(null))}),r.stdout.on("data",function(o){M(""+o)}),r.on("error",function(o){i=o,t(o)}),this};C.prototype.erase=C.prototype.clear;C.prototype.destroy=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["DELETE",this.path,"/f"];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i=null,s=ee(r);return r.on("close",function(o){i||(o!==0?(M("process exited with code "+o),t(te("DELETE",o,s),null)):t(null))}),r.stdout.on("data",function(o){M(""+o)}),r.on("error",function(o){i=o,t(o)}),this};C.prototype.create=function(t){if(typeof t!="function")throw new TypeError("must specify a callback");var e=["ADD",this.path,"/f"];ne(e,this.arch);var r=z(re(),e,{cwd:void 0,env:process.env,shell:!0,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),i=null,s=ee(r);return r.on("close",function(o){i||(o!==0?(M("process exited with code "+o),t(te("ADD",o,s),null)):t(null))}),r.stdout.on("data",function(o){M(""+o)}),r.on("error",function(o){i=o,t(o)}),this};C.prototype.keyExists=function(t){return this.values(function(e,r){if(e)return e.code==1?t(null,!1):t(e);t(null,!0)}),this};C.prototype.valueExists=function(t,e){return this.get(t,function(r,i){if(r)return r.code==1?e(null,!1):e(r);e(null,!0)}),this};Pn.exports=C});var lr=xe((no,Ye)=>{var Pt=function(){var n=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",r={};function i(o,a){if(!r[o]){r[o]={};for(var l=0;l<o.length;l++)r[o][o.charAt(l)]=l}return r[o][a]}var s={compressToBase64:function(o){if(o==null)return"";var a=s._compress(o,6,function(l){return t.charAt(l)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:s._decompress(o.length,32,function(a){return i(t,o.charAt(a))})},compressToUTF16:function(o){return o==null?"":s._compress(o,15,function(a){return n(a+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:s._decompress(o.length,16384,function(a){return o.charCodeAt(a)-32})},compressToUint8Array:function(o){for(var a=s.compress(o),l=new Uint8Array(a.length*2),c=0,u=a.length;c<u;c++){var f=a.charCodeAt(c);l[c*2]=f>>>8,l[c*2+1]=f%256}return l},decompressFromUint8Array:function(o){if(o==null)return s.decompress(o);for(var a=new Array(o.length/2),l=0,c=a.length;l<c;l++)a[l]=o[l*2]*256+o[l*2+1];var u=[];return a.forEach(function(f){u.push(n(f))}),s.decompress(u.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":s._compress(o,6,function(a){return e.charAt(a)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),s._decompress(o.length,32,function(a){return i(e,o.charAt(a))}))},compress:function(o){return s._compress(o,16,function(a){return n(a)})},_compress:function(o,a,l){if(o==null)return"";var c,u,f={},g={},m="",S="",E="",w=2,R=3,v=2,y=[],h=0,p=0,P;for(P=0;P<o.length;P+=1)if(m=o.charAt(P),Object.prototype.hasOwnProperty.call(f,m)||(f[m]=R++,g[m]=!0),S=E+m,Object.prototype.hasOwnProperty.call(f,S))E=S;else{if(Object.prototype.hasOwnProperty.call(g,E)){if(E.charCodeAt(0)<256){for(c=0;c<v;c++)h=h<<1,p==a-1?(p=0,y.push(l(h)),h=0):p++;for(u=E.charCodeAt(0),c=0;c<8;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1}else{for(u=1,c=0;c<v;c++)h=h<<1|u,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=0;for(u=E.charCodeAt(0),c=0;c<16;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1}w--,w==0&&(w=Math.pow(2,v),v++),delete g[E]}else for(u=f[E],c=0;c<v;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1;w--,w==0&&(w=Math.pow(2,v),v++),f[S]=R++,E=String(m)}if(E!==""){if(Object.prototype.hasOwnProperty.call(g,E)){if(E.charCodeAt(0)<256){for(c=0;c<v;c++)h=h<<1,p==a-1?(p=0,y.push(l(h)),h=0):p++;for(u=E.charCodeAt(0),c=0;c<8;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1}else{for(u=1,c=0;c<v;c++)h=h<<1|u,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=0;for(u=E.charCodeAt(0),c=0;c<16;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1}w--,w==0&&(w=Math.pow(2,v),v++),delete g[E]}else for(u=f[E],c=0;c<v;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1;w--,w==0&&(w=Math.pow(2,v),v++)}for(u=2,c=0;c<v;c++)h=h<<1|u&1,p==a-1?(p=0,y.push(l(h)),h=0):p++,u=u>>1;for(;;)if(h=h<<1,p==a-1){y.push(l(h));break}else p++;return y.join("")},decompress:function(o){return o==null?"":o==""?null:s._decompress(o.length,32768,function(a){return o.charCodeAt(a)})},_decompress:function(o,a,l){var c=[],u,f=4,g=4,m=3,S="",E=[],w,R,v,y,h,p,P,T={val:l(0),position:a,index:1};for(w=0;w<3;w+=1)c[w]=w;for(v=0,h=Math.pow(2,2),p=1;p!=h;)y=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(y>0?1:0)*p,p<<=1;switch(u=v){case 0:for(v=0,h=Math.pow(2,8),p=1;p!=h;)y=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(y>0?1:0)*p,p<<=1;P=n(v);break;case 1:for(v=0,h=Math.pow(2,16),p=1;p!=h;)y=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(y>0?1:0)*p,p<<=1;P=n(v);break;case 2:return""}for(c[3]=P,R=P,E.push(P);;){if(T.index>o)return"";for(v=0,h=Math.pow(2,m),p=1;p!=h;)y=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(y>0?1:0)*p,p<<=1;switch(P=v){case 0:for(v=0,h=Math.pow(2,8),p=1;p!=h;)y=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(y>0?1:0)*p,p<<=1;c[g++]=n(v),P=g-1,f--;break;case 1:for(v=0,h=Math.pow(2,16),p=1;p!=h;)y=T.val&T.position,T.position>>=1,T.position==0&&(T.position=a,T.val=l(T.index++)),v|=(y>0?1:0)*p,p<<=1;c[g++]=n(v),P=g-1,f--;break;case 2:return E.join("")}if(f==0&&(f=Math.pow(2,m),m++),c[P])S=c[P];else if(P===g)S=R+R.charAt(0);else return null;E.push(S),c[g++]=R+S.charAt(0),f--,R=S,f==0&&(f=Math.pow(2,m),m++)}}};return s}();typeof define=="function"&&define.amd?define(function(){return Pt}):typeof Ye<"u"&&Ye!=null?Ye.exports=Pt:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return Pt})});var Wi={};xr(Wi,{activate:()=>ji,deactivate:()=>Hi,isShinyAppFilename:()=>W,isShinyAppRPart:()=>Ge});module.exports=Sr(Wi);var Ft=_(require("path")),D=_(require("vscode"));var H=_(require("path")),d=_(require("vscode"));var bt=_(require("vscode"));function At(){let n=Xe();if(n)return t=>n.window.previewUrl(bt.Uri.parse(t))}async function kt(n){let t=Xe();if(t)return await t.runtime.getPreferredRuntime(n)}function Xe(){if(typeof globalThis?.acquirePositronApi=="function")return globalThis.acquirePositronApi()}function Dt(){return Xe()!==void 0}var Ot={r:{name:"r",properName:"R",fileExt:"R"},python:{name:"python",properName:"Python",fileExt:"py"}};function It(n){switch(n.slice(n.lastIndexOf(".")).toLowerCase()){case".py":return"python";case".r":return"r";default:return"text"}}function Se(n){return Ot[n].fileExt}function q(n){return Ot[n].properName}function Pr(){return["Claude Sonnet 4.5","Claude 4.5 Sonnet","Claude Haiku 4.5","Claude 4.5 Haiku","Claude Sonnet 4","Claude 4 Sonnet","Claude Haiku 4","Claude 4 Haiku"]}function Lt(){return["Claude Sonnet 4.5","Claude Haiku 4.5"]}function Ut(n){return Pr().some(e=>n.name.toLowerCase()===e.toLowerCase())}function Mt(n,t){let r=Lt().join(" or ");t.markdown(`It looks like you are using **${n}** for Copilot. `),t.markdown(`For best results with \`@shiny\`, please switch to **${r}**.

`),t.button({title:"I'll switch to a recommended model",command:"shiny.assistant.continueAfterDesiredModelSuggestion",arguments:[!0]}),t.button({title:`No thanks, I'll continue with ${n}`,command:"shiny.assistant.continueAfterDesiredModelSuggestion",arguments:[!1]})}function $t(){return Lt().join(" or ")}var jt=_(require("path")),Pe=class{files={};addFiles(t,e=null){for(let r of t)this.addFile(r,e)}addFile(t,e=null){if(t.type==="binary")throw new Error(`Binary files are not supported by ProposedFilePreviewProvider at this time: ${t.name}`);let r={...t};e&&(r.name=jt.join(e,t.name)),this.files[r.name]=r}provideTextDocumentContent(t){if(t.path.startsWith("/empty/"))return"";let e=this.files[t.path];return e?e.content:""}};var Gt=_(require("vscode"));var Wt=_(require("path")),Re=_(require("vscode"));function Ht(n){return n.replace(/\s+$/,"")}function Rr(n,t,e=!0){if(t==="")return{status:"success",value:n};let r=Cr(t);if(!(r instanceof Array))return r;let i=n.split(`
`),s=[],o=0;for(let a of r)if(a.old.length>0){let l=!1;for(let c=o;c<=i.length-a.old.length;c++){let u=!0;for(let f=0;f<a.old.length;f++){let g=i[c+f],m=a.old[f];if(e&&(g=Ht(g),m=Ht(m)),g!==m){u=!1;break}}if(u){for(;o<c;)s.push(i[o]),o++;for(let f of a.new)s.push(f);o+=a.old.length,l=!0;break}}if(!l)return console.log(`Could not find search pattern in chunk: ${a.old.join(`
`)}`),console.log(`Original: ${i.join(`
`)}`),{status:"error",message:"Could not find search pattern in chunk",extra:{pattern:a.old.join(`
`)}}}for(;o<i.length;)s.push(i[o]),o++;return{status:"success",value:s.join(`
`)}}async function _r(n,t){let r=(await Re.workspace.fs.readFile(Re.Uri.file(t))).toString(),i=Rr(r,n);return i.status==="error"&&(i.extra.fileName=t),i}async function Bt(n,t){let e={format:"complete",files:[]},r=[];for(let i of n.files){if(i.type==="binary"){r.push({status:"error",message:`Diff for binary file ${i.name} is not supported.`,extra:{filename:i.name}});continue}let s=await _r(i.content,Wt.join(t,i.name));if(s.status==="success"){let o={name:i.name,content:s.value,type:"text"};e.files.push(o)}else s.status==="error"&&r.push(s)}return{fileSet:e,diffErrors:r}}function Cr(n){let t=[],e=n.split(`
`),r=null;e.length>=2&&e[0].startsWith("---")&&e[1].startsWith("+++")&&(e.shift(),e.shift());for(let i of e)if(i==="@@ ... @@")r&&t.push(r),r={old:[],new:[]};else if(r){let s=i.slice(1);switch(i[0]){case"-":r.old.push(s);break;case"+":r.new.push(s);break;case" ":r.old.push(s),r.new.push(s);break;case void 0:r.old.push(""),r.new.push("");break;default:return{status:"error",message:`Unknown line type: ${i[0]}`,extra:{}}}}else return{status:"error",message:`Invalid diff format: ${i}`,extra:{}};return r&&t.push(r),t}var _e=class{currentState;states;constructor({initialState:t,states:e}){this.currentState=t,this.states=e}async send(t){let e=this.currentState,r=t.type,i=this.getTransitionsForEvent(e,r);if(!i)return;let s=Array.isArray(i)?i:[i];for(let o of s)if(o.guard){if(o.guard(t)){o.action&&await o.action(t),o.target&&(this.currentState=o.target);return}}else o.action&&await o.action(t),o.target&&(this.currentState=o.target)}getTransitionsForEvent(t,e){let r=this.states[t];if(r?.on?.[e])return r.on[e];if(r?.on?.["*"])return r.on["*"];let i=this.states["*"];if(i?.on?.[e])return i.on[e];if(i?.on?.["*"])return i.on["*"]}};var Ce=class{tagNames;contentHandler;state="TEXT";scannedText="";tagName=null;tagNamePartial="";kind="open";currentAttributeName="";currentAttributeValue="";attributes={};tagNamePartialIdx=0;potentialTagNameMatches=[];resetPotentialTagStateVars(){this.tagNamePartialIdx=0,this.potentialTagNameMatches=[...this.tagNames],this.tagName=null,this.tagNamePartial="",this.kind="open",this.currentAttributeName="",this.currentAttributeValue="",this.attributes={}}constructor({tagNames:t,contentHandler:e}){this.tagNames=[...t],this.contentHandler=e,this.resetPotentialTagStateVars()}async process(t){for(let e of t){if(this.state==="TEXT")e==="<"&&(this.scannedText.length>0&&(await this.contentHandler({type:"text",text:this.scannedText}),this.scannedText=""),this.state="TAG_START");else if(this.state==="TAG_START")if(e==="/")this.state="TAG_START_SLASH";else if(/^[a-zA-Z0-9]$/.test(e)){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)e!==this.potentialTagNameMatches[r][this.tagNamePartialIdx]&&this.potentialTagNameMatches.splice(r,1);this.potentialTagNameMatches.length===0&&(this.resetPotentialTagStateVars(),this.state="TEXT"),this.state="TAG_NAME",this.tagNamePartial=e,this.kind="open",this.tagNamePartialIdx++}else this.resetPotentialTagStateVars(),this.state="TEXT";else if(this.state==="TAG_START_SLASH")if(/^[a-zA-Z0-9]$/.test(e)){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)e!==this.potentialTagNameMatches[r][this.tagNamePartialIdx]&&this.potentialTagNameMatches.splice(r,1);this.potentialTagNameMatches.length===0&&(this.resetPotentialTagStateVars(),this.state="TEXT"),this.state="TAG_NAME",this.tagNamePartial=e,this.kind="close",this.tagNamePartialIdx++}else this.resetPotentialTagStateVars(),this.state="TEXT";else if(this.state==="TAG_NAME")if(e===" "||e===">"){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)this.tagNamePartialIdx!==this.potentialTagNameMatches[r].length&&this.potentialTagNameMatches.splice(r,1);if(this.potentialTagNameMatches.length===1)if(this.tagName=this.tagNamePartial,e===" ")this.state="WHITESPACE";else if(e===">")this.state="TAG_END";else throw new Error(`Unexpected character: ${e}`);else this.resetPotentialTagStateVars(),this.state="TEXT"}else if(/^[a-zA-Z0-9_-]$/.test(e)){for(let r=this.potentialTagNameMatches.length-1;r>=0;r--)e!==this.potentialTagNameMatches[r][this.tagNamePartialIdx]&&this.potentialTagNameMatches.splice(r,1);this.potentialTagNameMatches.length===0&&(this.resetPotentialTagStateVars(),this.state="TEXT"),this.tagNamePartial+=e,this.tagNamePartialIdx++}else this.resetPotentialTagStateVars(),this.state="TEXT";else this.state==="WHITESPACE"?/^[a-zA-Z0-9]$/.test(e)?(this.state="ATTR_NAME",this.currentAttributeName=e):e===" "||(e===">"?this.state="TAG_END":(this.resetPotentialTagStateVars(),this.state="TEXT")):this.state==="ATTR_NAME"?/^[a-zA-Z0-9_-]$/.test(e)?this.currentAttributeName+=e:e===" "?this.state="ATTR_NAME_END":e==="="?this.state="ATTR_EQUAL_FOUND":(this.resetPotentialTagStateVars(),this.state="TEXT"):this.state==="ATTR_NAME_END"?e===" "||(e==="="?this.state="ATTR_EQUAL_FOUND":(this.resetPotentialTagStateVars(),this.state="TEXT")):this.state==="ATTR_EQUAL_FOUND"?e===" "||(e==='"'?(this.state="IN_ATTR_VALUE_DOUBLE_QUOTE",this.currentAttributeValue=""):e==="'"?(this.state="IN_ATTR_VALUE_SINGLE_QUOTE",this.currentAttributeValue=""):(this.resetPotentialTagStateVars(),this.state="TEXT")):this.state==="IN_ATTR_VALUE_DOUBLE_QUOTE"?e==='"'?(this.state="ATTRIBUTE_VALUE_END",this.attributes[this.currentAttributeName]=this.currentAttributeValue,this.currentAttributeName="",this.currentAttributeValue=""):e===">"?(this.resetPotentialTagStateVars(),this.state="TEXT"):this.currentAttributeValue+=e:this.state==="IN_ATTR_VALUE_SINGLE_QUOTE"?e==="'"?(this.state="ATTRIBUTE_VALUE_END",this.attributes[this.currentAttributeName]=this.currentAttributeValue,this.currentAttributeName="",this.currentAttributeValue=""):e===">"?(this.resetPotentialTagStateVars(),this.state="TEXT"):this.currentAttributeValue+=e:this.state==="ATTRIBUTE_VALUE_END"&&(e===" "?this.state="WHITESPACE":e===">"?this.state="TAG_END":(this.resetPotentialTagStateVars(),this.state="TEXT"));this.scannedText+=e,this.state==="TAG_END"&&(await this.contentHandler({type:"tag",name:this.tagName,kind:this.kind,attributes:structuredClone(this.attributes),originalText:this.scannedText}),this.scannedText="",this.resetPotentialTagStateVars(),this.state="TEXT")}this.state==="TEXT"&&this.scannedText.length>0&&(await this.contentHandler({type:"text",text:this.scannedText}),this.scannedText="")}async flush(){this.scannedText.length>0&&(await this.contentHandler({type:"text",text:this.scannedText}),this.scannedText="")}};var Fr=["FILESET","FILE","DIFFCHUNK","DIFFOLD","DIFFNEW"],Fe=class{machine;streamingTagParser;config;fileSet=null;currentFile=null;diffErrors=[];fileStateHasRemovedFirstNewline=!1;diffOldStateHasRemovedFirstNewline=!1;diffOldStateLastCharWasNewline=!1;diffNewStateHasRemovedFirstNewline=!1;diffNewStateLastCharWasNewline=!1;constructor(t){this.config=t,this.streamingTagParser=new Ce({tagNames:Fr,contentHandler:e=>this.handlePiece(e)}),this.machine=new _e({initialState:"IN_TEXT",states:{IN_TEXT:{on:{text:{action:this.renderText.bind(this)},tag:[{guard:e=>e.kind==="open"&&e.name==="FILESET",target:"IN_FILESET",action:this.openFileset.bind(this)}]}},IN_FILESET:{on:{tag:[{guard:e=>e.kind==="close"&&e.name==="FILESET",target:"IN_TEXT",action:this.closeFileset.bind(this)},{guard:e=>e.kind==="open"&&e.name==="FILE",target:"IN_FILE",action:this.openFile.bind(this)}]}},IN_FILE:{on:{text:{guard:e=>e.type==="text",action:this.renderFileText.bind(this)},tag:[{guard:e=>e.kind==="close"&&e.name==="FILE",target:"IN_FILESET",action:this.closeFile.bind(this)},{guard:e=>e.kind==="open"&&e.name==="DIFFCHUNK",target:"IN_DIFFCHUNK",action:this.openDiffChunk.bind(this)}]}},IN_DIFFCHUNK:{on:{tag:[{guard:e=>e.kind==="open"&&e.name==="DIFFNEW",target:"IN_DIFFNEW",action:this.openDiffNew.bind(this)},{guard:e=>e.kind==="open"&&e.name==="DIFFOLD",target:"IN_DIFFOLD",action:this.openDiffOld.bind(this)},{guard:e=>e.kind==="close"&&e.name==="DIFFCHUNK",target:"IN_FILE"}]}},IN_DIFFNEW:{on:{text:{guard:e=>e.type==="text",action:this.renderDiffNewText.bind(this)},tag:[{guard:e=>e.kind==="close"&&e.name==="DIFFNEW",target:"IN_DIFFCHUNK"}]}},IN_DIFFOLD:{on:{text:{guard:e=>e.type==="text",action:this.renderDiffOldText.bind(this)},tag:[{guard:e=>e.kind==="close"&&e.name==="DIFFOLD",target:"IN_DIFFCHUNK"}]}},"*":{on:{"*":{action:e=>{console.log(`Unhandled event: in state "${this.machine.currentState}" and received event "${e.type}".`)}}}}}})}async process(t){await this.streamingTagParser.process(t)}async flush(){await this.streamingTagParser.flush()}hasFileSet(){return this.fileSet!==null}getDiffErrors(){return this.diffErrors}async handlePiece(t){if(t.type==="text")await this.machine.send({type:"text",text:t.text});else if(t.type==="tag")if(t.name==="FILESET")if(t.kind==="open"){let e=t.attributes.FORMAT??"complete";await this.machine.send({type:"tag",name:"FILESET",kind:"open",attributes:{FORMAT:e}})}else await this.machine.send({type:"tag",name:"FILESET",kind:"close"});else if(t.name==="FILE")if(t.kind==="open")if("NAME"in t.attributes){let e=t.attributes.NAME;await this.machine.send({type:"tag",name:"FILE",kind:t.kind,attributes:{NAME:e}})}else console.warn("FILE tag missing required NAME attribute");else await this.machine.send({type:"tag",name:"FILE",kind:"close"});else await this.machine.send({type:"tag",name:t.name,kind:t.kind})}renderText(t){this.config.stream.markdown(t.text)}openFileset(t){let e=t.attributes.FORMAT??"complete";if(e!=="complete"&&e!=="diff")throw new Error(`Invalid fileset format: ${e}`);this.fileSet={format:e,files:[]}}async closeFileset(t){this.config.incrementPreviewCounter();let e="/app-preview-"+this.config.proposedFilePreviewCounter;await this.processFileSetAsync(e)}async processFileSetAsync(t){if(this.fileSet.format==="diff"){for(let r of this.fileSet.files)r.type==="text"&&r.content.endsWith(`
`)&&(r.content=r.content.replace(/\n$/,""));let e=await Bt(this.fileSet,this.config.workspaceFolderUri.fsPath);this.fileSet=e.fileSet,this.diffErrors=e.diffErrors}this.config.proposedFilePreviewProvider.addFiles(this.fileSet.files,t),this.config.stream.button({title:"View changes as diff",command:"shiny.assistant.showDiff",arguments:[this.fileSet,this.config.workspaceFolderUri,t]}),this.config.stream.button({title:"Apply changes",command:"shiny.assistant.saveFilesToWorkspace",arguments:[this.fileSet.files,!0]}),this.config.stream.markdown(new Gt.MarkdownString(`After you apply the changes, press the $(run) button in the upper right of the app.${Se(this.config.projectLanguage)} editor panel to run the app.

`,!0))}openFile(t){if(!this.fileSet)throw new Error("Fileset not initialized");if(this.currentFile={name:t.attributes.NAME,content:"",type:"text"},this.fileSet.files.push(this.currentFile),this.fileStateHasRemovedFirstNewline=!1,this.config.stream.markdown(`
### `+t.attributes.NAME+`
`),this.config.stream.markdown("```"),this.fileSet.format==="diff")this.config.stream.markdown("diff");else{let e=It(t.attributes.NAME);e!=="text"&&this.config.stream.markdown(e)}this.config.stream.markdown(`
`)}renderFileText(t){let e=t.text;this.fileSet.format!=="diff"&&(this.fileStateHasRemovedFirstNewline||(e.startsWith(`
`)&&(e=e.slice(1)),this.fileStateHasRemovedFirstNewline=!0),this.currentFile.content+=e,this.config.stream.markdown(e))}closeFile(t){this.currentFile=null,this.config.stream.markdown("```"),this.config.stream.markdown(`
`)}openDiffChunk(t){this.currentFile.content+=`@@ ... @@
`,this.config.stream.markdown(`@@ ... @@
`)}openDiffOld(t){this.diffOldStateHasRemovedFirstNewline=!1,this.diffOldStateLastCharWasNewline=!1}renderDiffOldText(t){let e=t.text;this.diffOldStateLastCharWasNewline&&(e="-"+e),e.endsWith(`
`)?(this.diffOldStateLastCharWasNewline=!0,e=e.slice(0,-1).replaceAll(`
`,`
-`)+`
`):(this.diffOldStateLastCharWasNewline=!1,e=e.replaceAll(`
`,`
-`)),this.diffOldStateHasRemovedFirstNewline||(e.startsWith(`
`)&&(e=e.slice(1)),this.diffOldStateHasRemovedFirstNewline=!0),this.currentFile.content+=e,this.config.stream.markdown(e)}openDiffNew(t){this.diffNewStateHasRemovedFirstNewline=!1,this.diffNewStateLastCharWasNewline=!1}renderDiffNewText(t){let e=t.text;this.diffNewStateLastCharWasNewline&&(e="+"+e),e.endsWith(`
`)?(this.diffNewStateLastCharWasNewline=!0,e=e.slice(0,-1).replaceAll(`
`,`
+`)+`
`):(this.diffNewStateLastCharWasNewline=!1,e=e.replaceAll(`
`,`
+`)),this.diffNewStateHasRemovedFirstNewline||(e.startsWith(`
`)&&(e=e.slice(1)),this.diffNewStateHasRemovedFirstNewline=!0),this.currentFile.content+=e,this.config.stream.markdown(e)}};var ot=_(require("path")),on=_(sn());var Wr="assistant-prompts";async function an(n,t){try{if(!t.language)throw new Error("Project language not set");let e=ot.join(n.extensionPath,Wr),r=ot.join(e,"main.md"),i={language:q(t.language),fileExt:Se(t.language),projectSettings:JSON.stringify(t,null,2),verbosity:"Be very concise in the text."};return await on.renderFile(r,{autoEscape:!1,...i})}catch(e){return console.error("Failed to load system prompt:",e),""}}var Tt=_(require("path")),oe=_(require("vscode"));var se=_(require("vscode"));var ln=require("child_process");async function Me({cmd:n,args:t,cwd:e,env:r,stdout:i,stderr:s,timeoutMs:o=1500,verbose:a=!1}){let l=Br(a,"runShellCommand: ");return new Promise(c=>{let u={stdout:[],stderr:[]},f=(0,ln.spawn)(n,t,{cwd:e,env:r,timeout:o});function g(){l("Spawned")}function m(y){l("Error "+y.message),R(),c({status:"error",errorMsgs:y.message,...u})}function S(){l("Close"),R(),c({status:"success",...u})}function E(y){l(`stdout: ${y.toString()}`),u.stdout.push(y.toString()),i&&i(y.toString())}function w(y){l(`stderr: ${y.toString()}`),u.stderr.push(y.toString()),s&&s(y.toString())}function R(){clearTimeout(v),f.off("spawn",g),f.off("error",m),f.off("close",S),f.stdout.off("data",E),f.stderr.off("data",w)}let v=setTimeout(()=>{c({status:"error",errorMsgs:`Command, no response from run command within ${o}ms:
${n} ${t?.join(" ")}`,...u}),R()},o);f.on("spawn",g),f.on("error",m),f.on("close",S),f.stdout.on("data",E),f.stderr.on("data",w)})}function Br(n,t){return e=>{n&&console.log(t+e)}}var Gr="\x1B[32m",Vr="\x1B[0m";async function ue({cmd:n,args:t,cwd:e,env:r,terminal:i,newTerminalName:s,stdout:o,stderr:a,timeoutMs:l=1500,verbose:c=!1}){let u;return i||(se.window.terminals.forEach(g=>{let m=g.creationOptions;g.name===s&&"pty"in m&&m.pty&&m.pty instanceof $e&&g.dispose()}),i=Kr(s)),u=i.creationOptions.pty,i.show(),await u.openedPromise,u.write(`================================================================
`),u.write(`${Gr}Running command: ${JSON.stringify({cmd:n,args:t},void 0,"  ")}${Vr}
`),u.write(`
`),{cmdResult:await Me({cmd:n,args:t,cwd:e,env:r,stdout:g=>{u.write(g),o&&o(g)},stderr:g=>{u.write(g),a&&a(g)},timeoutMs:l,verbose:c}),terminal:i}}var $e=class{writeEmitter;onDidWrite;closeEmitter;onDidClose;openedPromise;openedPromiseResolve;constructor(){this.writeEmitter=new se.EventEmitter,this.onDidWrite=this.writeEmitter.event,this.closeEmitter=new se.EventEmitter,this.onDidClose=this.closeEmitter.event,this.openedPromise=new Promise(t=>{this.openedPromiseResolve=t})}write(t){this.writeEmitter.fire(t.replaceAll(`
`,`\r
`))}open(){this.openedPromiseResolve()}close(){this.writeEmitter.dispose(),this.closeEmitter.dispose()}dispose(){this.close()}};function Kr(n){let t=new $e,e=se.window.createTerminal({name:n,pty:t}),r=se.window.onDidCloseTerminal(function(s){s===e&&(t.dispose(),r.dispose())});return e}var Mn=_(cn()),mt=_(require("fs")),B=require("path"),F=_(require("vscode")),gt=_(Rn());var ut=_(require("http")),Nn=_(require("net")),k=_(require("vscode"));var _n=_(require("fs")),je=_(require("vscode"));async function Cn(n){if(ei())return await ti(n);let t=je.Uri.parse(`http://localhost:${n}`);return(await je.env.asExternalUri(t)).toString()}var Fn="/usr/lib/rstudio-server/bin/rserver-url";function ei(){return"RS_SERVER_URL"in process.env?_n.existsSync(Fn):!1}async function ti(n){let t=await Me({cmd:Fn,args:[String(n)]});t.status==="error"&&Error(`Failed to get Posit workbench forwarded port. Error msg:
`+t.errorMsgs);let e=process.env.RS_SERVER_URL,r=process.env.RS_SESSION_URL;if(!e||!r)throw new Error("Can't find URL for workbench.");let i=t.stdout[0];return`${e}${r.slice(1)}p/${i}/`}async function ct(n,t,e=20){let{result:r,cancel:i}=ni(e,t),s,o=new Promise(a=>{s=setTimeout(()=>a(void 0),n)});try{return await Promise.race([r,o])}finally{i(),s&&clearTimeout(s)}}function ni(n,t){let e=!1;async function r(){for(;!e;)try{return await t()}catch{await new Promise(i=>setTimeout(i,n))}throw new Error("Cancelled")}return{result:r(),cancel:()=>{e=!0}}}async function ri(n,t,e=1e3){return new Promise((r,i)=>{let s=new Nn.Socket;s.setTimeout(e),s.connect(t,n,function(){r(!0),s.end()}),s.on("timeout",()=>{s.destroy(),i(new Error("Timed out"))}),s.on("error",o=>{i(o)}),s.on("close",()=>{i(new Error("Connection closed"))})})}async function He(n,t=1e3){return await ct(t,async()=>{if(await ii(n)===!0)return!0;throw new Error(`Port ${n} is not open yet`)},80)===!0}async function ii(n){let t=ut.createServer(),e=new Promise((r,i)=>{t.on("listening",()=>r(!0)),t.on("error",()=>r(!1))}).finally(()=>{kn(t)});return t.listen(n,"127.0.0.1"),e}async function si(n){return new Promise(t=>{k.window.onDidCloseTerminal(e=>{e===n&&t(!0)})})}function oi(){return k.workspace.getConfiguration().get("shiny.timeoutOpenBrowser",10)*1e3}async function fe(n,t=[],e,r=oi()){if(bn()==="none")return;let i=await k.window.withProgress({location:k.ProgressLocation.Notification,title:"Waiting for Shiny app to start...",cancellable:!1},async o=>{let a=Date.now(),l=()=>{let f=Date.now(),g=(f-a)/r*100;o.report({increment:g}),a=f},c=[n,...t].map(f=>ct(r,()=>(l(),ri("127.0.0.1",f)))),u=Promise.all(c);return e?Promise.race([u,si(e)]):u});if(!Array.isArray(i)||e?.exitStatus!==void 0){console.warn("[shiny] Terminal has been closed, will not launch browser");return}if(i.filter(o=>!o).length>0){let o=Math.floor(r/1e3),a=await k.window.showErrorMessage(`Shiny app took longer than ${o}s to start so we have not opened the preview.`,e?"Show Shiny process":"","Keep waiting");if(a==="Keep waiting"){if(e?.exitStatus!==void 0){k.window.showErrorMessage("Shiny terminal was closed, please run the app again.");return}return fe(n,t,e,3e4)}a==="Show Shiny process"&&e?.show(),console.warn("[shiny] Failed to connect to Shiny app, not launching browser");return}let s=await Cn(n);await We(s)}function bn(){return k.workspace.getConfiguration().get("shiny.previewType")||"internal"}async function We(n){switch(bn()){case"none":return;case"external":{if(n==="about:blank")return;k.env.openExternal(k.Uri.parse(n));return}case"internal":{let e=At();if(e){e(n);return}}default:await k.commands.executeCommand("simpleBrowser.api.open",n,{preserveFocus:!0,viewColumn:k.ViewColumn.Beside})}}async function An(){do{let n=ut.createServer(),t=new Promise((r,i)=>{n.on("listening",()=>r(n.address().port)),n.on("error",i)}).finally(()=>{kn(n)});n.listen(0,"127.0.0.1");let e=await t;if(!ai.includes(e))return e}while(!0)}async function kn(n){return new Promise((t,e)=>{n.close(r=>{t()})})}var ai=[1,7,9,11,13,15,17,19,20,21,22,23,25,37,42,43,53,69,77,79,87,95,101,102,103,104,109,110,111,113,115,117,119,123,135,137,139,143,161,179,389,427,465,512,513,514,515,526,530,531,532,540,548,554,556,563,587,601,636,989,990,993,995,1719,1720,1723,2049,3659,4045,5060,5061,6e3,6566,6665,6666,6667,6668,6669,6697,10080];var pt=_(require("vscode"));var Dn={};async function Be(n,t="python"){return pt.workspace.getConfiguration(`shiny.${t}`).get("port")||await In(`app_${n}`)}async function On(n){return pt.workspace.getConfiguration("shiny.python").get("autoreloadPort")||await In(`autoreload_${n}`)}async function In(n){let t=Dn[n]??0;return t!==0||(t=await An(),Dn[n]=t),t}var Ln=_(require("vscode")),Un="PYSHINY_EXEC_SHELL";function li(n){let e=(n.creationOptions.env||{})[Un]??"";return/\bcmd\.exe$/i.test(e)?"cmd":/\b(powershell|pwsh).exe$/i.test(e)?"ps":"sh"}function ci(n,t){switch(t){case"cmd":return/\s/.test(n)?n.includes('"')?`"${n.replace(/"/g,'"""')}"`:`"${n}"`:n.replace(/([()%!^"<>&|])/g,"^$1");case"ps":return/[ '"`,;(){}|&<>@#[\]]/.test(n)?`'${n.replace(/'/g,"''")}'`:n;case"sh":return n.replace(/([\\ !"$`&*()|[\]{};<>?])/g,"\\$1");default:throw new Error('Unsupported style. Use "cmd", "ps", or "sh".')}}function ft(n,t,e){let r=li(n),i=[t].concat(...e).filter(s=>s!==null).map(s=>ci(s,r)).join(" ");return r==="ps"&&t?"& "+i:i}function dt(){return{[Un]:Ln.env.shell}}var ht="Debug Shiny app";async function $n(){let n=vt();if(!n||!await Gn())return;await yt();let t=await de();if(!t)return;let e=await Be("run","python"),r=await On("run"),i=await Bn({name:"Shiny",env:{PYSHINY_EXEC_CMD:t,...dt()}}),s=await Promise.all([He(e),He(r)]);if(!s[0]){F.window.showErrorMessage(`Unable to open server port ${e}.`);return}if(!s[1]){F.window.showErrorMessage(`Unable to open auto-reload port ${r}.`);return}let o=["-m","shiny","run"];o.push("--port",e+""),o.push("--reload"),o.push("--autoreload-port",r+""),o.push(n);let a=ft(i,t,o);i.sendText(a),await We("about:blank"),await new Promise(l=>setTimeout(l,1e3)),process.env.CODESPACES==="true"?await fe(r,[e],i):await fe(e,[r],i)}async function jn(){F.debug.activeDebugSession?.name===ht&&await F.debug.stopDebugging(F.debug.activeDebugSession);let n=vt();if(!n||!await Gn()||(await yt(),!await de()))return;let e=await Be("debug","python"),r=F.workspace.getConfiguration("shiny.python").get("debugJustMyCode",!0);await F.debug.startDebugging(void 0,{type:"python",name:ht,request:"launch",module:"shiny",args:["run","--port",e.toString(),n],jinja:!0,justMyCode:r,stopOnEntry:!1})}async function Hn(){let n=vt();if(!n)return;await yt();let t=Ge(n)?(0,B.dirname)(n):n,e=await Be("run","r"),r=await Bn({name:"Shiny",env:{...dt()}});if(!await He(e)){F.window.showErrorMessage(`Unable to open server port ${e}.`);return}let i=F.workspace.getConfiguration("shiny.r").get("devmode"),s=ui();if(!s)return;let a=[(0,B.join)(s,"rscripts","runShinyApp.R"),t,e+"",i?"--devmode":""],l=await wt("Rscript");if(!l){F.window.showErrorMessage("Could not find R. Is R installed on your system?If R is installed, please make sure your PATH environment variable is configured correctly.");return}let c=ft(r,l,a);r.sendText(c),await We("about:blank"),await new Promise(u=>setTimeout(u,1e3)),await fe(e,[],r)}function Wn(n){let{type:t,name:e}=n.configuration,r=n.configuration.args;if(t!=="python"||e!==ht||!r)return;let i=r.indexOf("--port");if(i<0||i===r.length-1)return;let s=r[i+1];if(!/^\d+$/.test(s))return;let o=parseInt(s);o<=0||fe(o).catch(a=>{console.warn("Failed to open browser",a)})}async function Bn(n){if(!n.name)throw new Error("Terminal name is required");let t=F.window.terminals.filter(i=>i.name===n.name),e=F.window.createTerminal(n);e.show(!0);let r=t.map(i=>{let s=new Promise(o=>{let a=F.window.onDidCloseTerminal(function(c){c===i&&(a.dispose(),o())})});return i.dispose(),s});return await Promise.allSettled(r),e}async function Gn(){return F.extensions.getExtension("ms-python.python")?!0:(await F.window.showErrorMessage("The Python extension is required to run Shiny apps. Please install it and try again.","Show Python extension","Not now")==="Show Python extension"&&F.commands.executeCommand("extension.open","ms-python.python"),!1)}async function de(){let n=await Mn.PythonExtension.api(),t=n.environments.getActiveEnvironmentPath(F.window.activeTextEditor?.document.uri),e=await n.environments.resolveEnvironment(t);return e?e.path:(F.window.showErrorMessage('Unable to find Python interpreter. Please use the "Python: Select Interpreter" command, and try again.'),!1)}function vt(){let n=F.window.activeTextEditor?.document.uri.fsPath;if(typeof n!="string"){F.window.showErrorMessage("No active file");return}return n}async function yt(){F.window.activeTextEditor?.document.isDirty&&await F.window.activeTextEditor?.document.save()}function ui(){let n=F.extensions.getExtension("Posit.shiny")?.extensionPath;if(!n){F.window.showErrorMessage("Cannot run Shiny app: failed to locate extension directory");return}return n}async function wt(n){return await pi(n)||fi(n)||di(n)||await hi(n)||""}async function pi(n){let t=await kt("r");if(!t)return"";console.log(`[shiny] runtimeMetadata: ${JSON.stringify(t)}`);let e=t.runtimePath;if(!e)return"";let{platform:r}=process,i=r==="win32"?".exe":"";return(0,B.join)((0,B.dirname)(e),n+i)}function fi(n){let{platform:t}=process,e=t==="win32"?".exe":"",r;switch(t){case"win32":r="windows";break;case"darwin":r="mac";break;default:r="linux"}let i=F.workspace.getConfiguration("r.rpath").get(r,void 0);return console.log(`[shiny] rPath: ${i}`),i?(0,B.join)((0,B.dirname)(i),n+e):""}function di(n="R"){let{platform:t}=process,e=t==="win32"?";":":",r=t==="win32"?".exe":"";if(!process.env.PATH)return"";for(let i of process.env.PATH.split(e)){let s=(0,B.join)(i,n+r);if(mt.existsSync(s))return s}return""}async function hi(n="R"){if(process.platform!=="win32")return"";let t="";try{let e=new gt({hive:gt.HKLM,key:"\\Software\\R-Core\\R"}),r=await new Promise((i,s)=>e.get("InstallPath",(o,a)=>o===null?i(a):s(o)));t=(0,B.join)(r.value,"bin",n+".exe"),t=mt.existsSync(t)?t:""}catch{t=""}return t}var Vn=_(require("vscode"));async function Kn(n,t,e,r){let i=await de();if(!i)return{cmdResult:{status:"error",stdout:[],stderr:[],errorMsgs:"No Python interpreter selected."},terminal:r.terminal,resultString:"No Python interpreter selected."};let s=[];for(let u of r.imports??[])s.push(`import ${u}`);s.push(`
def _parse_arg_json():
    import sys
    import json

    # If the first argument is "-c", then we need to ignore it.
    if sys.argv[0] == "-c":
        json_arg = sys.argv[1]
    else:
        json_arg = sys.argv[0]

    return json.loads(json_arg)
`),s.push("_args = _parse_arg_json()"),s.push(`
_fn = eval(_args["functionName"])
_res = _fn(*_args["args"], **_args["kwArgs"])`),s.push("import json"),s.push("print(json.dumps(_res, indent=2))");let o=["-c",s.join(`
`),JSON.stringify({functionName:n,args:t,kwArgs:e})],a="",l=u=>{a+=u},c=await ue({cmd:i,args:o,cwd:Vn.workspace.workspaceFolders?.[0]?.uri.fsPath,env:r.env,terminal:r.terminal,newTerminalName:r.newTerminalName,stdout:l,stderr:l});return r.terminal=c.terminal,c.cmdResult.status==="error"&&(a+=`
Error running Python function.`),{cmdResult:c.cmdResult,terminal:c.terminal,resultString:a}}var Yn=_(require("vscode"));async function qn(n,t,e){let r=await wt("Rscript");if(!r)return{cmdResult:{status:"error",stdout:[],stderr:[],errorMsgs:"Could not find R runtime. It seems to not be installed."},terminal:e.terminal,resultString:"Could not find R runtime. It seems to not be installed."};let s=[...(e.scriptPaths??[]).flatMap(c=>["-e",`source("${c}")`]),"-e",".args <- parse_arg_json()","-e",`.res <- do.call(${n}, .args)`,"-e","cat(to_json(.res))",JSON.stringify(t)],o="",a=c=>{o+=c},l=await ue({cmd:r,args:s,cwd:Yn.workspace.workspaceFolders?.[0]?.uri.fsPath,env:e.env,terminal:e.terminal,newTerminalName:e.newTerminalName,stdout:a,stderr:a});return e.terminal=l.terminal,l.cmdResult.status==="error"&&(o+=`
Error running R function.`),{cmdResult:l.cmdResult,terminal:l.terminal,resultString:o}}function he(){let{promise:n,resolve:t,reject:e}=mi(),r=!1,i=!1;return{promise:n,resolve(s){r=!0,t(s)},reject(s){i=!0,e(s)},then:n.then.bind(n),catch:n.catch.bind(n),finally:n.finally.bind(n),[Symbol.toStringTag]:"InitStatus",isResolved(){return r},isRejected(){return i},isCompleted(){return r||i}}}function mi(){let n,t;return{promise:new Promise((r,i)=>{n=r,t=i}),resolve:n,reject:t}}var me=[];function Jn(n){return n instanceof oe.LanguageModelToolResult?n:new oe.LanguageModelToolResult([new oe.LanguageModelTextPart(JSON.stringify(n))])}me.push({name:"shiny-assistant_setProjectLanguageTool",description:"Set the language of the project to R or Python. Only call this tool if the user specifically asks to set the language.",inputSchema:{type:"object",properties:{language:{type:"string",enum:["r","python"],description:"Programming language to use for the project"}},required:["language"]},invoke:({language:n},t)=>(t.stream.markdown(`

Setting project language to ${q(n)}...

`),L.language=n,`The project language has been set to ${q(n)}`)});me.push({name:"shiny-assistant_askUserForAppSubdirTool",description:"Ask the user which subdirectory of the workspace they want to use for their app.",inputSchema:{type:"object",properties:{defaultDir:{type:"string",description:'Default subdirectory to display to the user. For example, "./" or "myapp/". It should not have a leading slash.'}},required:["language"]},invoke:async({defaultDir:n},t)=>{let e;n==="./"?e="top level directory":e=`\`${n}\` subdirectory`,t.stream.markdown(`

Would you like to put your app in the ${e} of the project workspace?

`);let r=he();return t.stream.button({title:`Yes, use ${n}`,command:"shiny.assistant.setAppSubdir",arguments:[n,i=>{i&&r.resolve()}]}),t.stream.button({title:"No, I want to choose another subdirectory",command:"shiny.assistant.setAppSubdir",arguments:[null,i=>{i&&r.resolve()}]}),await r,t.stream.markdown(`You have set the app subdirectory to \`${L.appSubdir}/\`.

`),`User has set app subdirectory to: ${L.appSubdir}/.

`}});me.push({name:"shiny-assistant_checkPackageVersionTool",description:"Get the version of an R or Python package that is installed on the user's system.",inputSchema:{type:"object",properties:{language:{type:"string",enum:["r","python"],description:"Programming language that Shiny is being used with"},package:{type:"string",description:"Name of package to check the version of"},minVersion:{type:"string",description:"Minimum version of the package required"}},required:["language","package"]},invoke:async({language:n,package:t,minVersion:e},r)=>{r.stream.markdown(`

Checking version of ${t} for ${q(n)}...

`);let i;if(n==="r")i=await gi("check_package_version",{package:t,min_version:e??null},{extensionContext:r.extensionContext,env:{},terminal:r.terminal,newTerminalName:r.newTerminalName});else if(n==="python")i=await vi("tools.check_package_version",[],{package:t,min_version:e??null},{extensionContext:r.extensionContext,env:{},terminal:r.terminal,newTerminalName:r.newTerminalName});else return`Invalid language: ${n}`;r.terminal=i.terminal;let s=i.resultString;return i.cmdResult.status==="error"&&(s+=`
Error getting version of ${t}.`),s}});me.push({name:"shiny-assistant_installRequiredPackagesTool",description:"Installs necessary packages, for Python only.",inputSchema:{type:"object",properties:{language:{type:"string",enum:["r","python"],description:"Programming language that Shiny is being used with"}},required:["language"]},invoke:async({language:n},t)=>{let e,r=[],i="",s=oe.workspace.workspaceFolders;if(!(s&&s.length>0))return"No workspace folder found.";let o=s[0].uri.fsPath;if(t.stream.markdown(`

Installing required packages...

`),n==="r")return"Installing R packages is not supported yet.";if(n==="python"){if(e=await de(),!e)return"No Python interpreter selected";r=["-m","pip","install","-r","requirements.txt"]}else return`Invalid language: ${n}`;i=`Running command: 
\`\`\`
${e} ${r.join(" ")}
\`\`\`

`,t.stream.markdown(i),t.stream.progress("Running...");let a=await ue({cmd:e,args:r,cwd:o,terminal:t.terminal,newTerminalName:t.newTerminalName,timeoutMs:15e3,stdout:l=>{i+=l},stderr:l=>{i+=l}});return t.terminal=a.terminal,a.cmdResult.status==="error"&&(i+="Error installing packages."),i}});async function gi(n,t,e){let{extensionContext:r,...i}=e,s={...i,scriptPaths:[Tt.join(r.extensionPath,"assistant-prompts","tools.R")]};return await qn(n,t,s)}async function vi(n,t,e,r){let{extensionContext:i,env:s,...o}=r,a={...s};a.PYTHONPATH=Tt.join(i.extensionPath,"assistant-prompts")+(s.PYTHONPATH?`:${s.PYTHONPATH}`:"");let l={...o,env:a,imports:["tools"]};return await Kn(n,t,e,l)}var xt=new Pe,Xn=0,Qn="Proposed changes",Te=[],L={language:null,appSubdir:null},Et=he(),zn=he(),Zn=new d.CancellationTokenSource().token;function er(n){St(),Te.push(d.commands.registerCommand("shiny.assistant.saveFilesToWorkspace",tr),d.commands.registerCommand("shiny.assistant.applyChangesToWorkspaceFromDiffView",wi),d.commands.registerCommand("shiny.assistant.showDiff",Ti),d.commands.registerCommand("shiny.assistant.setProjectLanguage",(t,e)=>{L.language=t,e()}),d.commands.registerCommand("shiny.assistant.continueAfterDesiredModelSuggestion",t=>Et.resolve(t)),d.commands.registerCommand("shiny.assistant.continueAfterWorkspaceFolderSuggestion",()=>zn.resolve()),d.commands.registerCommand("shiny.assistant.setAppSubdir",xi),d.workspace.registerTextDocumentContentProvider("proposed-files",xt),yi(n)),Te.forEach(t=>n.subscriptions.push(t))}function St(){Te.length!==0&&(Te.forEach(n=>n.dispose()),Te.length=0)}function yi(n){let t=async(r,i,s,o)=>{let a={metadata:{command:void 0,followups:[],rawResponseText:""}};if(r.command==="start")return s.markdown(`Shiny Assistant can help you with building and deploying Shiny applications. You can ask me to:

  - Create a Shiny app
  - Modify an existing Shiny app
  - Install packages needed for your app
  - Troubleshoot a Shiny app

You can also ask me to explain the code in your Shiny app, or to help you with any other questions you have about Shiny.
        `),a.metadata.followups.push("Create a simple Shiny app."),a.metadata.followups.push("Install the packages needed for my app."),a;if(!Ut(r.model)&&!Et.isResolved()&&(Mt(r.model.name,s),await Et))return s.markdown(new d.MarkdownString(`Great! In the chat input box down below, switch to ${$t()}and then click on the $(refresh) button.

`,!0)),a;let l=d.workspace.workspaceFolders?.[0];if(!l&&(s.markdown(`You currently do not have an active workspace folder. You need an active workspace folder to use Shiny Assistant.

`),s.markdown(`Please open a folder by clicking on the **Open Folder** button in the sidebar, or by clicking on the **File** menu and then **Open Folder...** 

`),s.button({title:"Got it, continue",command:"shiny.assistant.continueAfterWorkspaceFolderSuggestion"}),await zn,l=d.workspace.workspaceFolders?.[0],!l))return s.markdown(`I'm sorry, I can't continue without an active workspace folder.

`),a;let c=l.uri,u=r.references.find(p=>(p.id==="vscode.implicit.viewport"||p.id==="vscode.implicit.selection")&&p.value instanceof d.Location&&p.value.uri.scheme==="file"),f=u?H.relative(c.fsPath,u.value.uri.fsPath):void 0;if(f&&!f.match("/")&&(f="./"+f),f){let p=H.basename(f),P;p.toLowerCase().endsWith(".r")?P="r":p.toLowerCase().endsWith(".py")?P="python":P="other",P!=="other"&&L.language!==P&&(L.language=P,s.markdown(`Based on the current file \`${f}\`, I see you are using ${q(L.language)}.

`))}if(L.language===null){s.markdown(`What language do you want to use for your Shiny app?

`);let p=he();s.button({title:"I'm using R",command:"shiny.assistant.setProjectLanguage",arguments:["r",p.resolve]}),s.button({title:"I'm using Python",command:"shiny.assistant.setProjectLanguage",arguments:["python",p.resolve]}),await p,s.progress("")}if(f&&W(f,L.language)){let p=H.dirname(f);L.appSubdir!==p&&(L.appSubdir=p,s.markdown(`Based on the current file \`${f}\`, the app subdirectory has been set to \`${L.appSubdir}/\`.

`),s.progress(""))}let g=i.history.map(p=>{if(p instanceof d.ChatRequestTurn)return d.LanguageModelChatMessage.User(p.prompt);if(p instanceof d.ChatResponseTurn){let P="";return p.result.metadata?.rawResponseText?P=p.result.metadata.rawResponseText:p.response.forEach(T=>{T instanceof d.ChatResponseMarkdownPart&&(P+=T.value.value)}),d.LanguageModelChatMessage.Assistant(P)}throw new Error(`Unknown message type in chat history: ${p}`)}),m=await an(n,L);g.unshift(d.LanguageModelChatMessage.User(m));let S=[...r.references];if(u){let p=u.value.uri,P={id:p.toString(),range:void 0,modelDescription:"file:"+H.basename(f),value:p};S.push(P)}let E=await Si(S,c);g.push(d.LanguageModelChatMessage.User(E.join(`
`))),g.push(d.LanguageModelChatMessage.User(r.prompt));let w=[...me,...d.lm.tools],R=[...r.toolReferences];w=w.filter(p=>p.description!=="");let v=!1,y="";async function h(){let p={},P=R.shift();P?(p.toolMode=d.LanguageModelChatToolMode.Required,p.tools=w.filter(T=>T.name===P.name)):(p.toolMode=d.LanguageModelChatToolMode.Auto,p.tools=w);try{let T=await r.model.sendRequest(g,p,o),N=[],b=[],Y="",G=new Fe({stream:s,workspaceFolderUri:c,proposedFilePreviewProvider:xt,proposedFilePreviewCounter:Xn,incrementPreviewCounter:()=>++Xn,projectLanguage:L.language});for await(let O of T.stream)O instanceof d.LanguageModelTextPart?(y+=O.value,Y+=O.value,await G.process(O.value)):O instanceof d.LanguageModelToolCallPart?N.push(O):console.log("Unknown part type: ",O);if(await G.flush(),b=G.getDiffErrors(),v=v||G.hasFileSet(),g.push(d.LanguageModelChatMessage.Assistant([new d.LanguageModelTextPart(Y),...N])),b.length>0&&(s.markdown(`The following errors occurred while applying the diff:

`),s.markdown(b.map(O=>O.message).join(`

`))),N.length>0){let O=[];for(let U of N){let V=w.find(le=>le.name===U.name);if(!V){console.log(`Tool not found: ${U.name}`);continue}let ae;if("invoke"in V){let le=await V.invoke(U.input,{stream:s,newTerminalName:"Shiny Assistant tool calls",terminal:void 0,extensionContext:n,cancellationToken:Zn});if(le===void 0){console.log(`Tool returned undefined: ${U.name}`);continue}ae=Jn(le)}else ae=await d.lm.invokeTool(V.name,{input:U.input,toolInvocationToken:r.toolInvocationToken},Zn);let j=new d.LanguageModelToolResultPart(U.callId,ae.content);O.push(j)}return g.push(d.LanguageModelChatMessage.User(O)),g.push(d.LanguageModelChatMessage.User("The messages above contain the results from one or more tool calls. The user can't see these results, so you should explain to the user if you reference them in your response.")),s.markdown(`

`),s.progress(""),y+=`

`,await h()}}catch(T){let N=null;if(T instanceof Error){if(!Dt()){let b=Ri(T);if(b&&b.error.code==="model_not_supported"){b.error.message==="The requested model is not supported."?(s.markdown(`The requested model, ${r.model.name} is not enabled. You can enable it at [https://github.com/settings/copilot](https://github.com/settings/copilot).

`),s.markdown(`Or you can send another message in this chat without \`@shiny\`, like \`"Hello"\`, and Copilot will ask you if you want to enable ${r.model.name}. After you enable it, remember to start the next message with \`@shiny\` again.

`),s.markdown("After enabling the model, you may need to reload this window or restart VS Code to use it.")):b.error.message==="Model is not supported for this request."?s.markdown(`The requested model, ${r.model.name} does not accept requests for Chat Participants, like \`@shiny\`. Please use a different model.`):s.markdown(`An error occurred while processing the response from the language model: ${T.message}.`);return}}N=T.message}s.markdown(`An error occurred while processing the response from the language model: ${N??T}.`)}}return await h(),a.metadata.rawResponseText=y,v&&a.metadata.followups.push("Install the packages needed for my app."),a},e=d.chat.createChatParticipant("chat.shiny-assistant",t);return e.followupProvider={provideFollowups:(r,i,s)=>r.metadata.followups.map(a=>typeof a=="string"?{prompt:a,command:""}:a)},e.iconPath=d.Uri.joinPath(n.extensionUri,"images/assistant-icon.svg"),e}async function wi(){return await tr(nr,!0)}async function tr(n,t=!1){let e=d.workspace.workspaceFolders?.[0]?.uri;if(!e)return d.window.showErrorMessage("You currently do not have an active workspace folder. Please open a workspace folder and try again."),!1;t&&await Ei();try{let r=[],i=[],s=new d.WorkspaceEdit;for(let a of n){if(a.type==="binary")return d.window.showErrorMessage(`Failed to handle file ${a.name}: Binary files are not supported at this time.`),!1;let l=d.Uri.joinPath(e,a.name);try{await d.workspace.fs.stat(l);let c=await d.workspace.openTextDocument(l);c.getText()!==a.content&&(s.set(l,[d.TextEdit.replace(new d.Range(c.positionAt(0),c.positionAt(c.getText().length)),a.content)]),r.push(l))}catch{s.createFile(l,{overwrite:!1,contents:new Uint8Array(Buffer.from(a.content,"utf-8"))}),i.push(l)}}await d.workspace.applyEdit(s);let o=null;for(let a of[...r,...i]){let l=await d.workspace.openTextDocument(a);["app.R","app.py"].includes(H.basename(a.fsPath))&&(o=l),await d.window.showTextDocument(l,{preserveFocus:!1}),await d.workspace.save(a)}return o&&await d.window.showTextDocument(o,{preserveFocus:!1}),!0}catch(r){return r instanceof Error&&d.window.showErrorMessage(`Failed to handle files: ${r.message}`),!1}}var nr=[];async function Ti(n,t,e){if(!t)return d.window.showErrorMessage("You currently do not have an active workspace folder. Please open a workspace folder and try again."),!1;nr=n.files;try{xt?.addFiles(n.files);let r=[];for(let i of n.files){let s=d.Uri.joinPath(t,i.name),o;try{if(await d.workspace.fs.stat(s),(await d.workspace.openTextDocument(s)).getText()===i.content)continue;o=s}catch{o=d.Uri.parse(`proposed-files://empty/${i.name}`)}let a=d.Uri.parse(`proposed-files://${e}/${i.name}`);r.push([d.Uri.parse("dummy-scheme://unused-label"),o,a])}return await d.commands.executeCommand("vscode.changes",Qn,r),!0}catch(r){return console.error("Error showing diff:",r),!1}}async function Ei(){let t=d.window.tabGroups.all.flatMap(e=>e.tabs).filter(e=>e.isPreview&&e.label.startsWith(Qn));for(let e of t)await d.window.tabGroups.close(e)}async function xi(n,t){if(n===null){let e={canSelectFiles:!1,canSelectFolders:!0,canSelectMany:!1,openLabel:"Select App Directory",title:"Select Shiny App Directory"},r=await d.window.showOpenDialog(e);if(r&&r.length>0){let i=d.workspace.workspaceFolders[0].uri.fsPath,s=H.relative(i,r[0].fsPath);L.appSubdir=s,t(!0)}else t(!1)}else n=n.replace(/^\/|\/$/g,""),L.appSubdir=n,t(!0)}async function Si(n,t){return(await Promise.all(n.map(r=>Pi(r,t)))).filter(r=>r!==void 0)}async function Pi(n,t){let e=n.value;if(e instanceof d.Uri){let r=H.relative(t.fsPath,e.fsPath),i=(await d.workspace.fs.readFile(e)).toString();return`
<context>
${r}:
\`\`\`
${i}
\`\`\`
</context>
`}else if(e instanceof d.Location){let r=H.relative(t.fsPath,e.uri.fsPath),i=(await d.workspace.openTextDocument(e.uri)).getText(e.range);return`
<context>
${r}:${e.range.start.line+1}-${e.range.end.line+1}:
\`\`\`
${i}
\`\`\`
</context>
`}else return typeof e=="string"?`
<context>
${e}
</context>
`:void 0}function Ri(n){let t="",e="",r=n.message.indexOf("{");r!==-1&&(t=n.message.substring(0,r),e=n.message.substring(r));let i=parseInt(t.match(/\d+/)?.[0]||"-1");if(e)try{let s=JSON.parse(e);if(s&&typeof s=="object"&&"error"in s&&typeof s.error=="object"&&"message"in s.error&&typeof s.error.message=="string"&&"param"in s.error&&typeof s.error.param=="string"&&"code"in s.error&&typeof s.error.code=="string"&&"type"in s.error&&typeof s.error.type=="string")return{summary:t,code:i,error:s.error}}catch{}return null}var hr=require("url"),K=_(require("vscode"));var sr=_(require("path"),1);var _i=["Dockerfile","Makefile","Rakefile","ada","adb","ads","applescript","as","ascx","asm","asmx","asp","aspx","atom","bas","bash","bashrc","bat","bbcolors","bdsgroup","bdsproj","bib","bowerrc","c","cbl","cc","cfc","cfg","cfm","cfml","cgi","clj","cls","cmake","cmd","cnf","cob","coffee","coffeekup","conf","cpp","cpt","cpy","crt","cs","csh","cson","csr","css","csslintrc","csv","ctl","curlrc","cxx","dart","dfm","diff","dockerignore","dof","dpk","dproj","dtd","eco","editorconfig","ejs","el","emacs","eml","ent","erb","erl","eslintignore","eslintrc","ex","exs","f","f03","f77","f90","f95","fish","for","fpp","frm","ftn","gemrc","gitattributes","gitconfig","gitignore","gitkeep","gitmodules","go","gpp","gradle","groovy","groupproj","grunit","gtmpl","gvimrc","h","haml","hbs","hgignore","hh","hpp","hrl","hs","hta","htaccess","htc","htm","html","htpasswd","hxx","iced","inc","ini","ino","int","irbrc","itcl","itermcolors","itk","jade","java","jhtm","jhtml","js","jscsrc","jshintignore","jshintrc","json","json5","jsonld","jsp","jspx","jsx","ksh","less","lhs","lisp","log","ls","lsp","lua","m","mak","map","markdown","master","md","mdown","mdwn","mdx","metadata","mht","mhtml","mjs","mk","mkd","mkdn","mkdown","ml","mli","mm","mxml","nfm","nfo","njk","noon","npmignore","npmrc","nvmrc","ops","pas","pasm","patch","pbxproj","pch","pem","pg","php","php3","php4","php5","phpt","phtml","pir","pl","pm","pmc","pod","pot","properties","props","pt","pug","py","r","rake","rb","rdoc","rdoc_options","resx","rhtml","rjs","rlib","rmd","ron","rs","rss","rst","rtf","rvmrc","rxml","s","sass","scala","scm","scss","seestyle","sh","shtml","sls","spec","sql","sqlite","ss","sss","st","strings","sty","styl","stylus","sub","sublime-build","sublime-commands","sublime-completions","sublime-keymap","sublime-macro","sublime-menu","sublime-project","sublime-settings","sublime-workspace","sv","svc","svg","t","tcl","tcsh","terminal","tex","text","textile","tg","tmLanguage","tmTheme","tmpl","toml","tpl","ts","tsv","tsx","tt","tt2","ttml","txt","v","vb","vbs","vh","vhd","vhdl","vim","viminfo","vimrc","vue","webapp","wxml","wxss","x-php","xaml","xht","xhtml","xml","xs","xsd","xsl","xslt","yaml","yml","zsh","zshrc"],rr=_i;var Ci=["dds","eot","gif","ico","jar","jpeg","jpg","pdf","png","swf","tga","ttf","zip"],ir=Ci;function Fi(n,t){if(n){let e=sr.basename(n).split(".").reverse();for(let r of e){if(rr.indexOf(r)!==-1)return!0;if(ir.indexOf(r)!==-1)return!1}}return t?Ve(t)==="utf8":null}function or(n,t){let e=Fi(n,t);return e==null?null:!e}function Ve(n,t){var e,r;if(!n)return null;let i="utf8",s="binary",o=(e=t?.chunkLength)!==null&&e!==void 0?e:24,a=(r=t?.chunkBegin)!==null&&r!==void 0?r:0;if(t?.chunkBegin==null){let l=Ve(n,{chunkLength:o,chunkBegin:a});return l===i&&(a=Math.max(0,Math.floor(n.length/2)-o),l=Ve(n,{chunkLength:o,chunkBegin:a}),l===i&&(a=Math.max(0,n.length-o),l=Ve(n,{chunkLength:o,chunkBegin:a}))),l}else{if(a=Ni(n,a),a===-1)return s;let l=bi(n,Math.min(n.length,a+o));if(l>n.length)return s;let c=n.toString(i,a,l);for(let u=0;u<c.length;++u){let f=c.charCodeAt(u);if(f===65533||f<=8)return s}return i}}function Ni(n,t){if(t===0)return 0;if(!Ai(n[t]))return t;let e=t-3;return e>=0&&ge(n[e])||(e=t-2,e>=0&&(ge(n[e])||Ke(n[e])))||(e=t-1,e>=0&&(ge(n[e])||Ke(n[e])||ar(n[e])))?e:-1}function bi(n,t){if(t===n.length)return t;let e=t-3;if(e>=0&&ge(n[e]))return t+1;if(e=t-2,e>=0){if(ge(n[e]))return t+2;if(Ke(n[e]))return t+1}if(e=t-1,e>=0){if(ge(n[e]))return t+3;if(Ke(n[e]))return t+2;if(ar(n[e]))return t+1}return t}function ge(n){return n>>3===30}function Ke(n){return n>>4===14}function ar(n){return n>>5===6}function Ai(n){return n>>6===2}var qe=_(lr()),$=_(require("path")),x=_(require("vscode"));async function cr(){if(!x.window.activeTextEditor){x.window.showErrorMessage("Shinylive: no editor is currently active.");return}let n=x.window.activeTextEditor.document.getText(),{fileName:t,languageId:e,isUntitled:r}=x.window.activeTextEditor.document;if(!e||!["r","python"].includes(e)){x.window.showErrorMessage("Shinylive only supports Python and R apps.");return}if(!r){let{name:o}=$.parse(t);if(!/(^app|app$)/i.test(o)){x.window.showErrorMessage("Shinylive: A single-file Shiny app is required when creating a link from the active editor.");return}}let i=e==="r"?"R":"py",s=[{name:`app.${i}`,content:n,type:"text"}];await ur(s,i.toLowerCase())}async function ur(n,t="py"){let e=await Oi();if(!e)return;let r=Rt({language:t,files:n,mode:e}),i=await Di();if(i)return i==="open"?x.env.openExternal(x.Uri.parse(r)):(await x.env.clipboard.writeText(r),x.window.showInformationMessage("Copied shinylive link to clipboard!")),r}async function Je(n){if(typeof n>"u"&&(n=await Ii()),!n)return;let t=_t(n);if(!t){x.window.showErrorMessage("Shinylive: Failed to parse the Shinylive link. Please check the link and try again.");return}let{files:e,language:r}=t;if(e.length<1){x.window.showErrorMessage("Shinylive: The provided link did not contain any files.");return}if(ki(e))return;let i=e.length===1,s;if(i){let l=await Li(e[0].name);l&&(e[0].name=$.basename(l.path),s=l.with({path:$.dirname(l.path)}))}else s=await Ui();if(!s)return;let o=await Mi(e,s,e.length>1);if(o.length===0)return;let a=await x.workspace.openTextDocument(o[0]);await x.window.showTextDocument(a,void 0,!1)}function ki(n){let t=n.map(e=>e.name).filter(e=>e.startsWith(".."));return t.length&&x.window.showErrorMessage("Shinylive link includes files that cannot be written into a single, contained directory, e.g. '"+t[0]+"'. Please edit the file paths on Shinylive and try again."),t.length>0}async function pr(n,t){let e=[];for(let u of t){let f=await fr(u);f&&e.push(...f)}let r=e.filter((u,f,g)=>f===g.findIndex(m=>m.fsPath===u.fsPath)).sort((u,f)=>{let g=W(u.path,"python")||W(u.path,"r"),m=W(f.path,"python")||W(f.path,"r");return-g+ +m}),i=r[0].path,s=W(i,"python"),o=W(i,"r");if(!s&&!o){x.window.showErrorMessage("Shinylive: the selected files did not contain a Shiny for Python or R app.");return}let a=$.dirname(i),l=u=>$.relative(a,u.path),c=await Promise.all(r.map(async u=>{let f=or(u.fsPath)?"binary":"text",g=l(u);u.path===i&&(s?g="app.py":o&&g.indexOf("app")>=0&&(g="app.R"));let m=await x.workspace.fs.readFile(u),S=f==="binary"?Buffer.from(m).toString("base64"):Buffer.from(m).toString();switch(f){case"binary":return{name:g,content:S,type:f};default:return{name:g,content:S}}}));await ur(c,s?"py":"r")}async function fr(n){if((await x.workspace.fs.stat(n)).type!==x.FileType.Directory)return[n];if(["_","."].some(i=>$.basename(n.path).startsWith(i)))return;let e=[],r=await x.workspace.fs.readDirectory(n);for(let[i,s]of r)if(s===x.FileType.Directory){let o=x.Uri.file(`${n.path}/${i}`),a=await fr(o);a&&e.push(...a)}else e.push(x.Uri.file(`${n.path}/${i}`));return e}async function Di(){let n=x.workspace.getConfiguration("shiny.shinylive").get("openAction")||"ask";if(["open","copy"].includes(n))return n;let t=await x.window.showQuickPick(["open","copy"],{title:"Open or copy the ShinyLive link?"});return t||""}async function Oi(){let n=x.workspace.getConfiguration("shiny.shinylive").get("appMode")||"ask";if(["app","editor"].includes(n))return n;let t=[{label:"app",detail:"App mode displays only the app on Shinylive."},{label:"editor",detail:"Editor mode displays the app alongside an editor and console."}],e=await x.window.showQuickPick(t,{title:"Which Shinylive mode?"});return e?e.label:""}async function Ii(){return await x.window.showInputBox({title:"Enter or paste a Shinylive link"})||""}var ve;async function Li(n){let t=ve||x.workspace.workspaceFolders?.[0].uri,e=x.Uri.joinPath(t,n),r=await x.window.showSaveDialog({defaultUri:e,saveLabel:"App file",title:"Choose a path for the Shinylive app",filters:n?n.endsWith(".py")?{Python:["py"]}:{R:["R","r"]}:void 0});if(!r){ve=t||x.Uri.file(".");return}return ve=r.with({path:$.dirname(r.path)}),r}async function Ui(){let n=ve||x.workspace.workspaceFolders?.[0].uri,t=await x.window.showSaveDialog({defaultUri:n,saveLabel:"App directory",title:"Choose a directory for the Shinylive app and files"});if(!t){ve=n||x.Uri.file(".");return}if(t.scheme!=="file"){x.window.showErrorMessage("Shinylive: Remote directories are not supported at this time. Please save the app locally instead.");return}try{await x.workspace.fs.createDirectory(t)}catch(e){x.window.showErrorMessage(`Shinylive failed to create new directory "${t.toString()}". ${e}`);return}return ve=t,t}function Rt({language:n,files:t,mode:e}){let r=JSON.stringify(t),i=qe.compressToEncodedURIComponent(r),s=x.workspace.getConfiguration("shiny.shinylive").get("host"),o;return e==="app"&&(o=x.workspace.getConfiguration("shiny.shinylive").get("includeHeader")),`${s}/${n}/${e}/#${o?"":"h=0&"}code=${i}`}function _t(n){let{hash:t,pathname:e}=new URL(n),{searchParams:r}=new URL("https://shinylive.io/?"+t.substring(1)),i=r.get("code");if(!i)return;let s=qe.decompressFromEncodedURIComponent(i),o=JSON.parse(s).map(u=>(u.name=$.normalize(u.name),u)),a=e.split("/"),l=a.includes("py")?"py":"r",c=a.includes("editor")?"editor":"app";return{language:l,mode:c,files:o}}async function Mi(n,t,e=!0){let r=[];for(let i of n){let s=x.Uri.joinPath(t,i.name),o=s.with({path:$.dirname(s.path)});if(o.scheme==="file"&&!await dr(o))try{await x.workspace.fs.createDirectory(o)}catch(l){return x.window.showErrorMessage(`Shinylive failed to create directory "${o.toString()}". ${l}`),[]}let a;switch(i.type){case"binary":a=Buffer.from(i.content,"base64");break;default:a=Buffer.from(i.content,"utf8");break}if(!e||await $i(s))try{await x.workspace.fs.writeFile(s,a),r.push(s)}catch(l){return x.window.showErrorMessage(`Shinylive failed to write file ${i.name} to "${s.toString()}". ${l}`),[]}}return r}async function $i(n){return n.scheme!=="file"||!await dr(n)?!0:await x.window.showInformationMessage(`File exists, overwrite? "${n.fsPath}"`,"Yes","No")==="Yes"}async function dr(n){try{return typeof(await x.workspace.fs.stat(n)).type<"u",!0}catch{return!1}}async function mr(n){if(!["/shinylive","/shinylive/"].includes(n.path)){console.warn(`[shiny] Unexpected URI: ${n.toString()}`);return}let t=new hr.URLSearchParams(n.query).get("url");if(!t){K.window.showErrorMessage("No URL provided in the Open from Shinylive link.");return}let e=decodeURIComponent(t),r=_t(e);if(!r){K.window.showErrorMessage("Shinylive: Failed to parse the Shinylive link. Please check the link and try again.");return}let i=r.files.slice(0,3).map(a=>a.name).join(", ");r.files.length>3&&(i+=`, and ${r.files.length-3} more files`);let s=await K.window.showWarningMessage(`You are about to save a Shinylive app with ${i} to your workspace. Would you like to...`,{modal:!0},{title:"Review the app on shinylive.io",action:"review"},{title:`Save app ${r.files.length===1?"file":"files"} locally`,action:"save"}),{action:o}=s||{action:"cancel"};if(o!=="cancel"){if(o==="review"){r.mode="editor";let a=Rt(r);if(K.env.openExternal(K.Uri.parse(a)),!await K.window.showInformationMessage("After reviewing the Shinylive app, would you like to save it?",{modal:!0},"Yes"))return;o="save"}if(o==="save"){await Je(e);return}}}async function ji(n){console.log("Activating Shiny extension"),n.subscriptions.push(D.commands.registerCommand("shiny.python.runApp",$n),D.commands.registerCommand("shiny.python.debugApp",jn),D.commands.registerCommand("shiny.r.runApp",Hn),D.commands.registerCommand("shiny.shinylive.createFromActiveEditor",cr),D.commands.registerCommand("shiny.shinylive.saveAppFromUrl",Je),D.commands.registerCommand("shiny.shinylive.createFromExplorer",pr),D.window.registerUriHandler({async handleUri(e){await mr(e)}})),er(n);let t=new Ct(2e3,()=>{gr("python"),gr("r")});n.subscriptions.push(t),n.subscriptions.push(D.window.onDidChangeActiveTextEditor(t.immediateCall.bind(t))),n.subscriptions.push(D.workspace.onDidChangeTextDocument(e=>{D.window.activeTextEditor?.document===e.document&&t.normalCall()})),t.immediateCall(),D.debug.onDidStartDebugSession(Wn)}function Hi(){St()}function gr(n){let t=`shiny.${n}.active`,e=D.window.activeTextEditor;if(!e)return D.commands.executeCommand("setContext",t,!1),!1;let r=e.document.languageId===n&&!e.document.isUntitled&&!!e.document.fileName&&W(e.document.fileName,n)&&e.document.getText().search(/\bshiny\b/)>=0;return D.commands.executeCommand("setContext",t,r),r}var Ct=class{_thresholdMillis;_callback;_timeout;_pending;constructor(t,e){this._thresholdMillis=t,this._callback=e,this._timeout=null,this._pending=!1}normalCall(){this._timeout?this._pending=!0:this._invoke()}immediateCall(){this._invoke()}_invoke(){this._clearTimer(),this._pending=!1;try{this._callback()}finally{this._timeout=setTimeout(()=>{this._clearTimer(),this._pending&&this._invoke()},this._thresholdMillis)}}_clearTimer(){this._timeout&&(clearTimeout(this._timeout),this._timeout=null)}dispose(){this._clearTimer(),this._pending=!1}};function W(n,t){n=Ft.basename(n);let e={python:"py",r:"R"}[t];if(!new RegExp(`\\.${e}$`,"i").test(n))return!1;let r=new RegExp(`^app\\.${e}$`,"i"),i=new RegExp(`^app[-_].+\\.${e}$`,"i"),s=new RegExp(`[-_]app\\.${e}$`,"i");return r.test(n)||i.test(n)||s.test(n)?!0:t==="r"?Ge(n):!1}function Ge(n){return n=Ft.basename(n),["ui.r","server.r","global.r"].includes(n.toLowerCase())}0&&(module.exports={activate,deactivate,isShinyAppFilename,isShinyAppRPart});
